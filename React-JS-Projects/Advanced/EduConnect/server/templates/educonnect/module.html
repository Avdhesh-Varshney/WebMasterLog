<!-- courses.html -->
{% extends 'base.html' %}

{% block title %}Modules - EduConnect{% endblock %}

{% block content %}
<!-- Your specific content for the courses page goes here -->

<style>
    .card {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        transform: translateY(-4px);
    }

    .card-body {
        background-color: rgba(255, 255, 255, 0.8);
        /* Adjust the alpha channel for transparency */
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .card:hover .card-body {
        background-color: rgba(255, 255, 255, 0.9);
        /* Adjust the alpha channel for transparency */
        backdrop-filter: blur(10px);
        /* Adjust the blur radius as needed */
    }

    .card-title {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }

    .card-text {
        color: #666;
    }


    .card-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        justify-content: center;
    }

    .module-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 200%;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .module-card:hover {
        background-color: #f0f0f0;
    }

    .module-card .module-image {
        width: 100%;
        height: auto;
        margin-bottom: 10px;
        border-radius: 5px;
    }

    .module-card .module-details {
        flex: 1;
    }

    .module-card .module-title {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .module-card .module-description {
        color: #666;
    }
</style>
</head>

<body>


    <!-- Header Start -->
    <div class="container-fluid bg-primary py-5 mb-5 page-header">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 id="courseName" class="display-3 text-white animated slideInDown">Module Name</h1>
                    <nav aria-label="breadcrumb">
                        <p class="text-white">Module Description</p>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <!-- Header End -->



    <!-- Courses Start -->
    <div id="courseContainer" class="container-xxl py-5">
        <div class="container">
            <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
                <h6 class="section-title bg-white text-center text-primary px-3">Let's play with Physics!</h6>
                <h1 class="mb-5">Course Overview</h1>
            </div>
            <div id="moduleList" class="row g-4 justify-content-center">
                <div class="row">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card" style="background-color: #2bc5d4;">
                                <div class="card-body">
                                    <h5 class="card-title">Modules</h5>
                                    <p class="card-text">Get to know about the Modules</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card" style="background-color:#1500ff;">
                                <div class="card-body">
                                    <h5 class="card-title" id="enrollButton" onclick="enrollCourse()">Enroll</h5>
                                    <br>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card" style="background-color:#2bc5d4 ;">
                                <div class="card-body">
                                    <h5 class="card-title">People</h5>
                                    <p class="card-text">Know your co-learners</p>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            </div>
        </div>
        <!-- Courses End -->

        <div class="container" style="margin-top: 48px;">
            <div class="container">
                <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
                    <h6 class="section-title bg-white text-center text-primary px-3">Peers</h6>
                    <h1 class="mb-5">Active Learners</h1>
                </div>
                <div class="row g-4 justify-content-center">
                    <div class="table-responsive">
                        <table id="userTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">S.No</th>
                                    <th scope="col">User ID</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table body will be filled dynamically using JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Enter Meeting Code</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="meetingForm">
                            <div class="form-group">
                                <p>Hey! Welcome EduBot portal!</p>
                                <p>Goto to <a href="http://localhost:3000">Virtual Portal</a> to get your meeting code.
                                    <br>
                                    If you have already got the code, please enter the meeting code to join the meeting.
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="receiverEmail">Receiver Email</label>
                                <input type="password" disabled class="form-control" id="receiverEmail" value=""
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="meetingCode">Meeting Code:</label>
                                <input type="text" class="form-control" id="meetingCode" required>
                            </div>
                            <div class="form-group my-4">
                                <label for="disclaimer">Disclaimer:</label>
                                <p>By clicking send, you agree to follow the rules and regulations of the meeting
                                    platform.
                                </p>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="submitBtn" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            // Function to check enrollment status
            const checkEnrollmentStatus = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('cid');

                // Fetch enrollment status
                fetch(`/enrollment/check-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cid: courseId })
                })

                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.enrolled) {
                            // User is already enrolled
                            document.getElementById('enrollButton').textContent = 'Already Enrolled';
                            document.getElementById('enrollButton').removeAttribute('onclick');
                        }
                    })
                    .catch(error => {
                        console.log('Error checking enrollment status:');
                        console.error(error);
                    });
            };
        </script>

        <script>
            // Function to get URL parameter value
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };

            // Assuming you have a div with the id "courseList" in your HTML where you want to append the module cards
            const courseListContainer = document.getElementById('moduleList');

            // Fetch module details from the API
            fetch('http://localhost:5000/learn/module_details?cid=' + getUrlParameter('cid'))
                .then(response => response.json())
                .then(data => {
                    // Create HTML for each course module
                    data.forEach(modules => {
                        const moduleCard = document.createElement('div');
                        moduleCard.classList.add('col-md-4');

                        const cardContent = `
                        <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                            <div class="course-item bg-light">
                                <div class="position-relative overflow-hidden">
                                    <img class="img-fluid" src="https://environment.leeds.ac.uk/images/resized/600x300-0-0-1-80-1_19.jpg" alt="${modules.name}">
                                    <div class="w-100 d-flex justify-content-center position-absolute bottom-0 start-0 mb-4">
                                        <a href="#" class="flex-shrink-0 btn btn-sm btn-primary px-3 border-end" style="border-radius: 30px 0 0 30px;">Read More</a>
                                        <a href="#" class="flex-shrink-0 btn btn-sm btn-primary px-3" style="border-radius: 0 30px 30px 0;">Join Now</a>
                                    </div>
                                </div>
                                <div class="text-center p-4 pb-0">
                                    <div class="mb-3">
                                        <small class="fa fa-star text-primary"></small>
                                        <small class="fa fa-star text-primary"></small>
                                        <small class="fa fa-star text-primary"></small>
                                        <small class="fa fa-star text-primary"></small>
                                        <small class="fa fa-star text-primary"></small>
                                        <small>(123)</small>
                                    </div>
                                    <h5 class="mb-4">${modules.name}</h5>
                                    <p class="card-text">${modules.description}</p>
                                </div>
                            </div>
                        </div>
                    `;

                        courseListContainer.innerHTML += cardContent;
                    });
                })
                .catch(error => {
                    console.error('Error fetching module details:', error);
                });
        </script>

        <script>
            // Fetch course details from the API
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('cid');

            fetch(`http://localhost:5000/learn/course/${courseId}`)
                .then(response => response.json())
                .then(course => {
                    // Update course name
                    document.getElementById('courseName').textContent = course.name;

                    // Update course description
                    const courseDescription = document.querySelector('.page-header p');
                    courseDescription.textContent = course.description;
                })
                .catch(error => {
                    console.error('Error fetching course details:', error);
                });

            // Function to handle enrollment
            const enrollCourse = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('cid');
                console.log(courseId);


                fetch('http://localhost:5000/enrollment/enroll-course?cid=' + courseId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cid: courseId })
                })
                    .then(response => {
                        if (response.ok) {
                            alert('Enrollment successful!');
                            document.getElementById('enrollStatus').textContent = 'Enrolled';
                        } else {
                            alert('Enrollment failed. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error enrolling course:', error);
                        alert('An error occurred while enrolling. Please try again later.');
                    });
            };

            // Check enrollment status when the page loads
            window.onload = checkEnrollmentStatus;
        </script>

        <script>
            $(document).ready(function () {
                const urlParams = new URLSearchParams(window.location.search);
                const cid = urlParams.get('cid');
                // Fetch data from the API
                if (cid) {
                    $.ajax({
                        url: 'http://localhost:5000/enrollment/get-users-by-course-id?cid=' + cid,
                        type: 'GET',
                        dataType: 'json',
                        success: function (response) {
                            // Populate the table with the fetched data
                            console.log(response.users);
                            if (response.users && response.users.length > 0) {
                                $.each(response.users, function (index, user) {
                                    var rowNum = index + 1;
                                    var userEmail = user.status === 1 ? '*****' : user.email; // Check user status
                                    var newRow = '<tr>' +
                                        '<td>' + rowNum + '</td>' +
                                        '<td>' + user.id + '</td>' +
                                        '<td>' + userEmail + '</td>' + // Use userEmail instead of user.email
                                        '<td>' +
                                        '<button type="button" class="btn btn-primary btn-sm" >Message</button>' +
                                        '<button type="button" class="btn btn-success message-btn btn-sm mx-4" data-bs-toggle="modal" data-bs-target="#exampleModal" data-email="' + user.email + '">Meet Now</button>' +
                                        '</td>' +
                                        '</tr>';
                                    $('#userTable tbody').append(newRow);
                                });

                                $('.message-btn').click(function () {
                                    var userEmail = $(this).data('email');
                                    sessionStorage.setItem('selectedUserEmail', userEmail);
                                    var selectedUserEmail = sessionStorage.getItem('selectedUserEmail');
                                    $('#receiverEmail').val(selectedUserEmail);
                                });
                            } else {
                                // No users found
                                $('#userTable tbody').append('<tr><td colspan="4">No users found</td></tr>');
                            }
                        },
                        error: function (xhr, status, error) {
                            // Error handling
                            console.error('Error:', error);
                            $('#userTable tbody').append('<tr><td colspan="4">Error fetching data</td></tr>');
                        }
                    });
                }
                else {
                    $('#userTable tbody').append('<tr><td colspan="4">No users found</td></tr>');
                    console.error('cid parameter is missing');
                }

                $('#submitBtn').click(function () {
                    var meetingCode = $('#meetingCode').val();
                    var receiverEmail = $('#receiverEmail').val();
                    console.log('Meeting code:', meetingCode);
                    console.log('Receiver email:', receiverEmail);
                    console.log('Course ID:', cid);
                    $.ajax({
                        url: 'http://localhost:5000/enrollment/sendmail?cid=' + cid,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            meeting_code: meetingCode,
                            receiver_email: receiverEmail
                        }),
                        success: function (response) {
                            console.log('Mail sent successfully:', response);
                            // You can add any success handling here, such as showing a success message
                            // Close the modal
                            $('#meetingModal').modal('hide');
                            // Clear the input fields
                            $('#meetingCode').val('');
                            $('#receiverEmail').val('');
                        },
                        error: function (xhr, status, error) {
                            console.error('Error sending mail:', error);
                            // You can add any error handling here, such as showing an error message
                        }
                    });
                });

            });



        </script>

        {% endblock %}